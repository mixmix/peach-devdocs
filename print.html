<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PeachCloud: Developer Documentation</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Hardware</a></li><li><ol class="section"><li class="expanded "><a href="chapter_2_1.html"><strong aria-hidden="true">2.1.</strong> Requirements</a></li><li class="expanded "><a href="chapter_2_2.html"><strong aria-hidden="true">2.2.</strong> GPIO Pinout</a></li><li class="expanded "><a href="chapter_2_3.html"><strong aria-hidden="true">2.3.</strong> Physical Interface</a></li></ol></li><li class="expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Software</a></li><li><ol class="section"><li class="expanded "><a href="chapter_3_1.html"><strong aria-hidden="true">3.1.</strong> Operating System</a></li><li><ol class="section"><li class="expanded "><a href="chapter_3_1_1.html"><strong aria-hidden="true">3.1.1.</strong> Networking</a></li></ol></li><li class="expanded "><a href="chapter_3_2.html"><strong aria-hidden="true">3.2.</strong> Microservices</a></li><li><ol class="section"><li class="expanded "><a href="chapter_3_2_1.html"><strong aria-hidden="true">3.2.1.</strong> peach-buttons</a></li><li class="expanded "><a href="chapter_3_2_2.html"><strong aria-hidden="true">3.2.2.</strong> peach-menu</a></li><li class="expanded "><a href="chapter_3_2_3.html"><strong aria-hidden="true">3.2.3.</strong> peach-network</a></li><li class="expanded "><a href="chapter_3_2_4.html"><strong aria-hidden="true">3.2.4.</strong> peach-oled</a></li><li class="expanded "><a href="chapter_3_2_5.html"><strong aria-hidden="true">3.2.5.</strong> peach-stats</a></li></ol></li><li class="expanded "><a href="chapter_3_3.html"><strong aria-hidden="true">3.3.</strong> Web Interface</a></li><li class="expanded "><a href="chapter_3_4.html"><strong aria-hidden="true">3.4.</strong> Configuration</a></li></ol></li><li class="expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> Contributor's Guide</a></li><li class="expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Licensing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">PeachCloud: Developer Documentation</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<p>PeachCloud is a low-power, lightweight hardware device designed to facilitate peer-to-peer communication across social networks. We aim to return (cloud) computing back into our homes and local communities in a way which fosters increased trust in one another and the socio-technical systems we inhabit.</p>
<h1><a class="header" href="#hardware" id="hardware">Hardware</a></h1>
<h1><a class="header" href="#requirements" id="requirements">Requirements</a></h1>
<p>Minimal hardware component requirements for prototyping and development:</p>
<ul>
<li>Raspberry Pi 3B+ / 4</li>
<li>OLED display
<ul>
<li>128 x 64 pixels</li>
<li>SSD1306-compatible</li>
</ul>
</li>
<li>Buttons
<ul>
<li>7 push-buttons <em>or</em> 2 push-buttons and 1 5-direction joystick</li>
</ul>
</li>
</ul>
<h1><a class="header" href="#gpio-pinout" id="gpio-pinout">GPIO Pinout</a></h1>
<h1><a class="header" href="#physical-interface" id="physical-interface">Physical Interface</a></h1>
<p>The PeachCloud physical interface consists of a 5-way joystick, two push-buttons and a 128x64 OLED display.</p>
<p>Development is taking place on the <a href="https://www.adafruit.com/product/3531">AdaFruit 128x64 1.3&quot; OLED Bonnet</a>.</p>
<p><em>Note: the 5-way joystick may be replaced by four or five push-buttons in the release version of the physical interface.</em></p>
<h3><a class="header" href="#control" id="control">Control</a></h3>
<p>The OLED display shows the PeachCloud logo on start-up. Pressing the <code>A</code> button (<code>#5</code>) loads the root of the menu system. The <code>UP</code> and <code>DOWN</code> directions on the joystick allow scrolling through the menu options, while the <code>A</code> button functions as Select and the <code>B</code> button (<code>#6</code>) functions as Back.</p>
<p>Any button or joystick direction can be pressed to wake the display after selecting Display Off.</p>
<h3><a class="header" href="#menu-structure" id="menu-structure">Menu Structure</a></h3>
<pre><code>.
├── Networking
│   └── MODE
│   └── STATUS
│   └── NETWORK
│   └── IP
│   └── SIGNAL
│   └── Configuration
│       ├── Client Mode
│       └── Access Point Mode
├── System Stats
│   └── CPU
│   └── MEM
│   └── LOAD
│   └── UPTIME
│   └── DATA RX
│   └── DATA TX
├── Display Off
└── Shutdown
</code></pre>
<h1><a class="header" href="#software" id="software">Software</a></h1>
<h1><a class="header" href="#operating-system" id="operating-system">Operating System</a></h1>
<p>PeachCloud runs an <em>unofficial</em> <a href="https://people.debian.org/%7Egwolf/raspberrypi3/20190628/">preview image</a> of Debian 10 (Buster). Kernel version: 4.19.0-5-arm64.</p>
<h1><a class="header" href="#networking" id="networking">Networking</a></h1>
<p>PeachCloud has three primary network interfaces: <code>eth0</code>, <code>wlan0</code> and <code>ap0</code> (virtual interface). The device supports two wireless modes: client and access point (AP).</p>
<p>In client mode, the <code>wlan0</code> interface is managed by <code>wpa_supplicant</code>. This allows the PeachCloud device to connect to a WiFi access point in the vicinity. The IP address of the <code>wlan0</code> interface is dynamically-assigned by the WiFi router it is associated with. While the device is running in this mode, the <code>ap0</code> interface is set <code>DOWN</code> and the <code>dnsmasq</code> and <code>hostapd</code> processes are stopped.</p>
<p>In access point mode, the <code>ap0</code> interface is managed by <code>hostapd</code> - with DNS and DHCP leasing being handled by <code>dnsmasq</code>. The IP address of the <code>ap0</code> interface is set to <code>11.11.11.10</code> by default. Connected devices are leased IP addresses in the range of <code>11.11.11.11 - 11.11.11.30</code> (<em>for now</em>). While the device is running in this mode, the <code>wlan0</code> interface is set <code>DOWN</code> and the <code>wpa_supplicant</code> process is stopped. </p>
<p>The <code>peach-network</code> microservice exposes <code>activate_ap()</code> and <code>activate_client()</code> RPC calls for simple switching of the networking mode. This functionality is also exposed by the menu system of the physical interface.</p>
<h1><a class="header" href="#microservices" id="microservices">Microservices</a></h1>
<p>PeachCloud is built primarily with a <a href="https://microservices.io/">microservices architecture</a>. Each microservice utilises <a href="https://www.jsonrpc.org/specification">JSON-RPC</a> - a stateless, light-weight remote procedure call protocol - as a means of exposing functionality and allowing interoperability. This approach produces a collection of services which are highly maintainable and testable, loosely coupled and independently deployable. HTTP and WebSockets are used as transports for the microservices.</p>
<p>The suite of PeachCloud microservices currently includes:</p>
<ul>
<li><strong>peach-buttons</strong> <a href="https://github.com/peachcloud/peach-buttons">(repo)</a>
<ul>
<li>poll GPIO pins for button presses and emit events via pub-sub</li>
</ul>
</li>
<li><strong>peach-menu</strong> <a href="https://github.com/peachcloud/peach-menu">(repo)</a>
<ul>
<li>monitor and interact with the device via the physical interface</li>
</ul>
</li>
<li><strong>peach-network</strong> <a href="https://github.com/peachcloud/peach-network">(repo)</a>
<ul>
<li>query and configure network interfaces</li>
</ul>
</li>
<li><strong>peach-oled</strong> <a href="https://github.com/peachcloud/peach-oled">(repo)</a>
<ul>
<li>write and draw to the OLED display</li>
</ul>
</li>
<li><strong>peach-stats</strong> <a href="https://github.com/peachcloud/peach-menu">(repo)</a>
<ul>
<li>query system statistics</li>
</ul>
</li>
</ul>
<h1><a class="header" href="#peach-buttons" id="peach-buttons">peach-buttons</a></h1>
<p>GPIO microservice module for handling button presses. <code>peach-buttons</code> implements a JSON-RPC server with <a href="https://docs.rs/jsonrpc-pubsub/11.0.0/jsonrpc_pubsub/">Publish-Subscribe extension</a>. Each button press results in a JSON-RPC request being sent over websockets to any subscribers. A button code for the pressed button is sent with the request to subscribers, allowing state-specific actions to be taken by the subscriber.</p>
<p>In the case of PeachCloud, the <code>peach-menu</code> microservice subscribes to <code>peach-buttons</code> in order to update the state of the menu after each button press.</p>
<p><em>Note: This module is relatively stable but is still a work-in-progress.</em></p>
<h3><a class="header" href="#directory-tree" id="directory-tree">Directory Tree</a></h3>
<pre><code>.
├── Cargo.lock
├── Cargo.toml
├── README.md
├── src
│   ├── error.rs        // custom ButtonError type and From implementation
│   ├── interrupt.rs    // interrupt handler with GPIO polling
│   ├── lib.rs          // RPC server and pubsub handler, pin definitions
│   └── main.rs         // init logger, call run() &amp; catch application errors
</code></pre>
<h3><a class="header" href="#pin-to-button-to-button-code-mappings" id="pin-to-button-to-button-code-mappings">Pin to Button to Button Code Mappings</a></h3>
<pre><code>4 =&gt; Center =&gt; 0,
27 =&gt; Left =&gt; 1,
23 =&gt; Right =&gt; 2,
17 =&gt; Up =&gt; 3,
22 =&gt; Down =&gt; 4,
5 =&gt; A =&gt; 5,
6 =&gt; B =&gt; 6
</code></pre>
<p><em>Note: <code>peach-buttons</code> utilizes the GPIO character device ABI. This API, stabilized with Linux v4.4, deprecates the legacy sysfs interface to GPIOs that is planned to be removed from the upstream kernel after year 2020.</em></p>
<h3><a class="header" href="#setup" id="setup">Setup</a></h3>
<p>Clone this repo:</p>
<p><code>git clone https://github.com/peachcloud/peach-buttons.git</code></p>
<p>Move into the repo and compile:</p>
<p><code>cd peach-buttons</code><br />
<code>cargo build --release</code></p>
<p>Run the binary with sudo:</p>
<p><code>sudo ./target/release/peach-buttons</code></p>
<p>Logging is made availabe with <code>env_logger</code>:</p>
<p><code>sudo RUST_LOG=info ./target/release/peach-buttons</code></p>
<p><em>Other logging levels include debug, warn and error.</em></p>
<h3><a class="header" href="#testing-subscription" id="testing-subscription">Testing Subscription</a></h3>
<p>Request:</p>
<p><code>{&quot;id&quot;:1,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;subscribe_buttons&quot;}</code></p>
<p>Response:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:1,&quot;id&quot;:1}</code></p>
<p>Event:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;button_press&quot;,&quot;params&quot;:[0]}</code></p>
<h3><a class="header" href="#licensing" id="licensing">Licensing</a></h3>
<p>AGPL-3.0</p>
<h1><a class="header" href="#peach-menu" id="peach-menu">peach-menu</a></h1>
<p><a href="https://travis-ci.com/peachcloud/peach-menu"><img src="https://travis-ci.com/peachcloud/peach-menu.svg?branch=master" alt="Build Status" /></a></p>
<p>OLED menu microservice module for PeachCloud. A state machine which listens for GPIO events (button presses) by subscribing to <code>peach-buttons</code> over websockets and makes <a href="https://www.jsonrpc.org/specification">JSON-RPC</a> calls to relevant PeachCloud microservices (<code>peach-network</code>, <code>peach-oled</code>, <code>peach-stats</code>).</p>
<p><em>Note: This module is a work-in-progress.</em></p>
<h3><a class="header" href="#directory-tree-1" id="directory-tree-1">Directory Tree</a></h3>
<pre><code>.
├── Cargo.lock
├── Cargo.toml
├── README.md
├── src
│   ├── buttons.rs          // JSON-RPC WebSocket client for peach-buttons
│   ├── error.rs            // custom MenuError type &amp; From implementations
│   ├── lib.rs              // launch state machine &amp; RPC client for buttons
│   ├── main.rs             // init logger, call run() &amp; catch application errors
│   ├── network.rs          // JSON-RPC HTTP client for peach-network
│   ├── oled.rs             // JSON-RPC HTTP client for peach-oled
│   ├── state_machine.rs    // state machine &amp; state_changer()
│   ├── states.rs           // state-specific logic called by state machine
│   ├── stats.rs            // JSON-RPC HTTP client for peach-stats
│   └── structs.rs          // data types used by RPC clients
</code></pre>
<h3><a class="header" href="#button-code-mappings" id="button-code-mappings">Button Code Mappings</a></h3>
<pre><code>0 =&gt; Center,  
1 =&gt; Left,  
2 =&gt; Right,  
3 =&gt; Up,  
4 =&gt; Down,  
5 =&gt; A,  
6 =&gt; B
</code></pre>
<h3><a class="header" href="#states" id="states">States</a></h3>
<pre><code>Home(0), // home menu
Home(1), // networking selected
Home(2), // system stats selected
Home(3), // display off selected
Home(4), // shutdown selected 
Logo, // logo splash screen
Network, // network device view
NetworkConf(0), // network configuration menu
NetworkConf(1), // client mode selected
NetworkConf(2), // access point mode selected
NetworkMode(0), // client mode activated
NetworkMode(1), // access point mode activated
OledPower(0), // oled display off
OledPower(1), // oled display on
Shutdown, // shutting down
Stats, // system statistics view
</code></pre>
<h3><a class="header" href="#setup-1" id="setup-1">Setup</a></h3>
<p>Clone this repo:</p>
<p><code>git clone https://github.com/peachcloud/peach-menu.git</code></p>
<p>Move into the repo and compile:</p>
<p><code>cd peach-menu</code><br />
<code>cargo build --release</code></p>
<p>Run the binary:</p>
<p><code>./target/target/peach-menu</code></p>
<p><em>Note: Will currently panic if <code>peach_buttons</code> is not running (connection to ws server fails).</em></p>
<h3><a class="header" href="#environment" id="environment">Environment</a></h3>
<p>The JSON-RPC HTTP server address and port for the OLED microservice can be configured with the <code>PEACH_OLED_SERVER</code> environment variable:</p>
<p><code>export PEACH_OLED_SERVER=127.0.0.1:5000</code></p>
<p>When not set, the value defaults to <code>127.0.0.1:5112</code>.</p>
<p>Logging is made available with <code>env_logger</code>:</p>
<p><code>export RUST_LOG=info</code></p>
<p>Other logging levels include <code>debug</code>, <code>warn</code> and <code>error</code>.</p>
<h3><a class="header" href="#resources" id="resources">Resources</a></h3>
<p>This work was made much, much easier by the awesome blog post titled <a href="https://hoverbear.org/2016/10/12/rust-state-machine-pattern/">Pretty State Machine Patterns in Rust</a> by <a href="https://hoverbear.org/about/">hoverbear</a>. Thanks hoverbear!</p>
<h3><a class="header" href="#licensing-1" id="licensing-1">Licensing</a></h3>
<p>AGPL-3.0</p>
<h1><a class="header" href="#peach-network" id="peach-network">peach-network</a></h1>
<p><a href="https://travis-ci.com/peachcloud/peach-network"><img src="https://travis-ci.com/peachcloud/peach-network.svg?branch=master" alt="Build Status" /></a></p>
<p>Networking microservice module for PeachCloud. Query and configure device interfaces using <a href="https://www.jsonrpc.org/specification">JSON-RPC</a> over HTTP.</p>
<p>Interaction with wireless interfaces occurs primarily through the <a href="https://docs.rs/wpactrl/0.3.1/wpactrl/">wpactrl crate</a> which provides &quot;a pure-Rust lowlevel library for controlling wpasupplicant remotely&quot;. This approach is akin to using <code>wpa_cli</code> (a WPA command line client).</p>
<p><em>Note: This module is a work-in-progress.</em></p>
<h3><a class="header" href="#json-rpc-api" id="json-rpc-api">JSON-RPC API</a></h3>
<table><thead><tr><th>Method</th><th>Parameters</th><th>Description</th></tr></thead><tbody>
<tr><td><code>activate_ap</code></td><td></td><td>Activate WiFi access point (stop <code>wpa_supplicant</code> and start <code>hostapd</code> and <code>dnsmasq</code>)</td></tr>
<tr><td><code>activate_client</code></td><td></td><td>Activate WiFi client connection (stop <code>hostapd</code> and <code>dnsmasq</code> and start <code>wpa_supplicant</code>)</td></tr>
<tr><td><code>add_wifi</code></td><td><code>ssid</code>, <code>pass</code></td><td>Connect to WiFi with given SSID and password</td></tr>
<tr><td><code>get_ip</code></td><td><code>iface</code></td><td>Return IP of given network interface</td></tr>
<tr><td><code>get_rssi</code></td><td><code>iface</code></td><td>Return average signal strength for given interface</td></tr>
<tr><td><code>get_ssid</code></td><td><code>iface</code></td><td>Return SSID of currently-connected network for given interface</td></tr>
<tr><td><code>get_state</code></td><td><code>iface</code></td><td>Return state of given interface</td></tr>
<tr><td><code>get_traffic</code></td><td><code>iface</code></td><td>Return network traffic for given interface</td></tr>
<tr><td><code>if_checker</code></td><td></td><td>Run AP / client-mode configuration script</td></tr>
<tr><td><code>list_networks</code></td><td></td><td>List all networks saved in wpasupplicant config</td></tr>
<tr><td><code>ping</code></td><td></td><td>Respond with <code>success</code> if microservice is running</td></tr>
<tr><td><code>scan_networks</code></td><td><code>iface</code></td><td>List all networks in range of given interface</td></tr>
<tr><td><code>reconnect_wifi</code></td><td><code>iface</code></td><td>Disconnect and reconnect given interface</td></tr>
<tr><td><code>reassociate_wifi</code></td><td><code>iface</code></td><td>Reassociate with current AP for given interface</td></tr>
</tbody></table>
<h3><a class="header" href="#directory-tree-2" id="directory-tree-2">Directory Tree</a></h3>
<pre><code>.
├── Cargo.lock
├── Cargo.toml
├── README.md
├── src
│   ├── error.rs        // custom NetworkError type &amp; From implementations
│   ├── lib.rs          // RPC server, methods &amp; tests
│   ├── main.rs         // init logger, call run() &amp; catch application errors
│   └── network.rs      // logic for network methods exposed via RPC
</code></pre>
<h3><a class="header" href="#setup-2" id="setup-2">Setup</a></h3>
<p>Clone this repo:</p>
<p><code>git clone https://github.com/peachcloud/peach-network.git</code></p>
<p>Move into the repo and compile:</p>
<p><code>cd peach-network</code><br />
<code>cargo build --release</code></p>
<p>Run the binary (sudo needed to satisfy permission requirements):</p>
<p><code>sudo ./target/release/peach-network</code></p>
<h3><a class="header" href="#environment-1" id="environment-1">Environment</a></h3>
<p>The JSON-RPC HTTP server address and port can be configured with the <code>PEACH_NETWORK_SERVER</code> environment variable:</p>
<p><code>export PEACH_NETWORK_SERVER=127.0.0.1:5000</code></p>
<p>When not set, the value defaults to <code>127.0.0.1:5110</code>.</p>
<p>Logging is made available with <code>env_logger</code>:</p>
<p><code>export RUST_LOG=info</code></p>
<p>Other logging levels include <code>debug</code>, <code>warn</code> and <code>error</code>.</p>
<h3><a class="header" href="#example-usage" id="example-usage">Example Usage</a></h3>
<p><strong>Retrieve IP address for wlan0</strong></p>
<p>With microservice running, open a second terminal window and use <code>curl</code> to call server methods:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_ip&quot;, &quot;params&quot; : {&quot;iface&quot;: &quot;wlan0&quot; }, &quot;id&quot;:1 }' 127.0.0.1:5000</code></p>
<p>Server responds with:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;192.168.1.21&quot;,&quot;id&quot;:1}</code></p>
<p><strong>Retrieve SSID of connected access point for wlan1</strong></p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_ssid&quot;, &quot;params&quot; : {&quot;iface&quot;: &quot;wlan1&quot; }, &quot;id&quot;:1 }' 127.0.0.1:5000</code></p>
<p>Server response when interface is connected:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;Home&quot;,&quot;id&quot;:1}</code></p>
<p>Server response when interface is not connected:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:{&quot;code&quot;:-32003,&quot;message&quot;:&quot;Failed to retrieve SSID for wlan1. Interface may not be connected.&quot;},&quot;id&quot;:1}</code></p>
<p><strong>Retrieve list of SSIDs for all networks in range of wlan0</strong></p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;scan_networks&quot;, &quot;params&quot; : {&quot;iface&quot;: &quot;wlan0&quot; }, &quot;id&quot;:1 }' 127.0.0.1:5000</code></p>
<p>Server response when interface is connected:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;[\&quot;Home\&quot;,\&quot;TP-LINK_254700\&quot;]&quot;,&quot;id&quot;:1}</code></p>
<p>Server response when interface is not connected:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:{&quot;code&quot;:-32006,&quot;message&quot;:&quot;No networks found in range of wlan0&quot;},&quot;id&quot;:1}</code></p>
<p><strong>Retrieve network traffic statistics for wlan1</strong></p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_traffic&quot;, &quot;params&quot; : {&quot;iface&quot;: &quot;wlan1&quot; }, &quot;id&quot;:1 }' 127.0.0.1:5000</code></p>
<p>Server response if interface exists:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;{\&quot;received\&quot;:26396361,\&quot;transmitted\&quot;:22352530}&quot;,&quot;id&quot;:1}</code></p>
<p>Server response when interface is not found:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:{&quot;code&quot;:-32004,&quot;message&quot;:&quot;Failed to retrieve network traffic for wlan3. Interface may not be connected&quot;},&quot;id&quot;:1}</code></p>
<h3><a class="header" href="#licensing-2" id="licensing-2">Licensing</a></h3>
<p>AGPL-3.0</p>
<h1><a class="header" href="#peach-oled" id="peach-oled">peach-oled</a></h1>
<p><a href="https://travis-ci.com/peachcloud/peach-oled"><img src="https://travis-ci.com/peachcloud/peach-oled.svg?branch=master" alt="Build Status" /></a></p>
<p>OLED microservice module for PeachCloud. Write to a 128x64 OLED display with SDD1306 driver (I2C) using <a href="https://www.jsonrpc.org/specification">JSON-RPC</a> over HTTP.</p>
<h3><a class="header" href="#json-rpc-api-1" id="json-rpc-api-1">JSON-RPC API</a></h3>
<table><thead><tr><th>Method</th><th>Parameters</th><th>Description</th></tr></thead><tbody>
<tr><td><code>clear</code></td><td></td><td>Clear the display buffer</td></tr>
<tr><td><code>draw</code></td><td><code>bytes</code>, <code>width</code>, <code>height</code>, <code>x_coord</code>, <code>y_coord</code></td><td>Draw graphic to display buffer for given byte array, dimensions and co-ordinates</td></tr>
<tr><td><code>flush</code></td><td></td><td>Flush the display</td></tr>
<tr><td><code>ping</code></td><td></td><td>Respond with <code>success</code> if microservice is running</td></tr>
<tr><td><code>write</code></td><td><code>x_coord</code>, <code>y_coord</code>, <code>string</code>, <code>font_size</code></td><td>Write message to display buffer for given co-ordinates using given font size</td></tr>
</tbody></table>
<p><code>peach-oled</code> allows text to be written with the following font sizes:</p>
<table><thead><tr><th>Font Sizes</th></tr></thead><tbody>
<tr><td><code>6x8</code></td></tr>
<tr><td><code>6x12</code></td></tr>
<tr><td><code>8x16</code></td></tr>
<tr><td><code>12x16</code></td></tr>
</tbody></table>
<h3><a class="header" href="#directory-tree-3" id="directory-tree-3">Directory Tree</a></h3>
<pre><code>.
├── Cargo.lock
├── Cargo.toml
├── docs
│   └── images
│       └── peachcloud_oled.jpg
├── README.md
├── src
│   ├── error.rs        // custom OledError type &amp; From implementations
│   ├── lib.rs          // RPC server, methods &amp; tests (includes OLED logic)
│   └── main.rs         // init logger, call run() &amp; catch application errors
</code></pre>
<h3><a class="header" href="#setup-3" id="setup-3">Setup</a></h3>
<p>Clone this repo:</p>
<p><code>git clone https://github.com/peachcloud/peach-oled.git</code></p>
<p>Move into the repo and compile:</p>
<p><code>cd peach-oled</code><br />
<code>cargo build --release</code></p>
<p>Run the binary:</p>
<p><code>./target/release/peach-oled</code></p>
<h3><a class="header" href="#environment-2" id="environment-2">Environment</a></h3>
<p>The JSON-RPC HTTP server address and port can be configured with the <code>PEACH_OLED_SERVER</code> environment variable:</p>
<p><code>export PEACH_OLED_SERVER=127.0.0.1:5000</code></p>
<p>When not set, the value defaults to <code>127.0.0.1:5112</code>.</p>
<p>Logging is made available with <code>env_logger</code>:</p>
<p><code>export RUST_LOG=info</code></p>
<p>Other logging levels include <code>debug</code>, <code>warn</code> and <code>error</code>.</p>
<h3><a class="header" href="#example-usage-1" id="example-usage-1">Example Usage</a></h3>
<p><strong>Write Text to the OLED Display</strong></p>
<p>With microservice running, open a second terminal window and use <code>curl</code> to call server methods:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;write&quot;, &quot;params&quot; : {&quot;x_coord&quot;: 0, &quot;y_coord&quot;: 0, &quot;string&quot;: &quot;Welcome to PeachCloud&quot;, &quot;font_size&quot;: &quot;6x8&quot; }, &quot;id&quot;:1 }' 127.0.0.1:5112</code></p>
<p>Server responds with:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:success&quot;,&quot;id&quot;:1}</code></p>
<p>OLED will remain blank because no flush command has been issued.</p>
<p>Write to the second line of the display:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;write&quot;, &quot;params&quot; : {&quot;x_coord&quot;: 0, &quot;y_coord&quot;: 8, &quot;string&quot;: &quot;Born in cypherspace&quot;, &quot;font_size&quot;: &quot;6x12&quot; }, &quot;id&quot;:1 }' 127.0.0.1:5112</code></p>
<p>Flush the display:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;flush&quot;, &quot;id&quot;:1 }' 127.0.0.1:5112</code></p>
<p>OLED display shows:</p>
<p><code>Welcome to PeachCloud!</code><br />
<code>Born in cypherspace</code></p>
<p>Validation checks are performed for all three parameters: <code>x_coord</code>, <code>y_coord</code> and <code>string</code>. An appropriate error is returned if the validation checks are not satisfied:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:{&quot;code&quot;:1,&quot;message&quot;:&quot;Validation error: coordinate x out of range 0-128: 129.&quot;},&quot;id&quot;:1}</code></p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:{&quot;code&quot;:1,&quot;message&quot;:&quot;validation error&quot;,&quot;data&quot;:&quot;y_coord not in range 0-57&quot;},&quot;id&quot;:1}</code></p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:{&quot;code&quot;:1,&quot;message&quot;:&quot;Validation error: string length 47 out of range 0-21.&quot;},&quot;id&quot;:1}</code></p>
<p>An error is returned if one or all of the expected parameters are not supplied:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:{&quot;code&quot;:-32602,&quot;message&quot;:&quot;Invalid params: missing field </code>font_size<code>.&quot;},&quot;id&quot;:1}</code></p>
<hr />
<p><strong>Draw Graphic to the OLED Display</strong></p>
<p>With microservice running, open a second terminal window and use <code>curl</code> to call server methods:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;draw&quot;, &quot;params&quot; : {&quot;bytes&quot;: [30, 0, 33, 0, 64, 128, 128, 64, 140, 64, 140, 64, 128, 64, 64, 128, 33, 0, 30, 0], &quot;width&quot;: 10, &quot;height&quot;: 10, &quot;x_coord&quot;: 32, &quot;y_coord&quot;: 32}, &quot;id&quot;:1 }' 127.0.0.1:5112</code></p>
<p>Server responds with:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:success&quot;,&quot;id&quot;:1}</code></p>
<p>OLED will remain blank because no flush command has been issued.</p>
<p>Flush the display:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;flush&quot;, &quot;id&quot;:1 }' 127.0.0.1:5112</code></p>
<p>OLED display shows a 10x10 graphic of a dot inside a circle.</p>
<p>No validation checks are currently performed on the parameters of the <code>draw</code> RPC, aside from type-checks when the parameters are parsed.</p>
<hr />
<p><strong>Clear the Display</strong></p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;clear&quot;, &quot;id&quot;:1 }' 127.0.0.1:5112</code></p>
<p>Server responds with:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2,0&quot;,&quot;result&quot;:&quot;success&quot;,&quot;id&quot;:1}</code></p>
<h3><a class="header" href="#licensing-3" id="licensing-3">Licensing</a></h3>
<p>AGPL-3.0</p>
<h1><a class="header" href="#peach-stats" id="peach-stats">peach-stats</a></h1>
<p><a href="https://travis-ci.com/peachcloud/peach-stats"><img src="https://travis-ci.com/peachcloud/peach-stats.svg?branch=master" alt="Build Status" /></a></p>
<p>System statistics microservice module for PeachCloud. Provides a JSON-RPC wrapper around the <a href="https://crates.io/crates/probes">probes</a> and <a href="https://crates.io/crates/systemstat">systemstat</a> crates.</p>
<h3><a class="header" href="#json-api" id="json-api">JSON-API</a></h3>
<table><thead><tr><th>Method</th><th>Description</th><th>Returns</th></tr></thead><tbody>
<tr><td><code>cpu_stats</code></td><td>CPU statistics</td><td><code>user</code>, <code>system</code>, <code>nice</code>, <code>idle</code></td></tr>
<tr><td><code>cpu_stats_percent</code></td><td>CPU statistics as percentages</td><td><code>user</code>, <code>system</code>, <code>nice</code>, <code>idle</code></td></tr>
<tr><td><code>disk_usage</code></td><td>Disk usage statistics (array of disks)</td><td><code>filesystem</code>, <code>one_k_blocks</code>, <code>one_k_blocks_used</code>, <code>one_k_blocks_free</code>, <code>used_percentage</code>, <code>mountpoint</code></td></tr>
<tr><td><code>load_average</code></td><td>Load average statistics</td><td><code>one</code>, <code>five</code>, <code>fifteen</code></td></tr>
<tr><td><code>mem_stats</code></td><td>Memory statistics</td><td><code>total</code>, <code>free</code>, <code>used</code></td></tr>
<tr><td><code>uptime</code></td><td>System uptime</td><td><code>secs</code>, <code>nanos</code></td></tr>
</tbody></table>
<h3><a class="header" href="#directory-tree-4" id="directory-tree-4">Directory Tree</a></h3>
<pre><code>.
├── Cargo.lock
├── Cargo.toml
├── README.md
└── src
    ├── error.rs        // custom StatError type &amp; From implementations
    ├── lib.rs          // RPC server, methods &amp; tests
    ├── main.rs         // init logger, call run() &amp; catch application errors
    ├── stats.rs        // logic for stats methods exposed via RPC
    └── structs.rs      // data types for stats
</code></pre>
<h3><a class="header" href="#setup-4" id="setup-4">Setup</a></h3>
<p>Clone this repo:</p>
<p><code>git clone https://github.com/peachcloud/peach-stats.git</code></p>
<p>Move into the repo and compile a release build:</p>
<p><code>cd peach-stats</code><br />
<code>cargo build --release</code></p>
<p>Run the binary:</p>
<p><code>./target/release/peach-stats</code></p>
<h3><a class="header" href="#environment-3" id="environment-3">Environment</a></h3>
<p>The JSON-RPC HTTP server address and port can be configured with the <code>PEACH_STATS_SERVER</code> environment variable:</p>
<p><code>export PEACH_STATS_SERVER=127.0.0.1:5000</code></p>
<p>When not set, the value defaults to <code>127.0.0.1:5113</code>.</p>
<p>Logging is made available with <code>env_logger</code>:</p>
<p><code>export RUST_LOG=info</code></p>
<p>Other logging levels include <code>debug</code>, <code>warn</code> and <code>error</code>.</p>
<h3><a class="header" href="#example-usage-2" id="example-usage-2">Example Usage</a></h3>
<p><strong>Get CPU Statistics</strong></p>
<p>With microservice running, open a second terminal window and use <code>curl</code> to call server methods:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;cpu_stats&quot;, &quot;id&quot;:1 }' 127.0.0.1:5113</code></p>
<p>Server responds with:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;{\&quot;user\&quot;:4661083,\&quot;system\&quot;:1240371,\&quot;idle\&quot;:326838290,\&quot;nice\&quot;:0}&quot;,&quot;id&quot;:1}</code></p>
<p><strong>Get System Uptime</strong></p>
<p>With microservice running, open a second terminal window and use <code>curl</code> to call server methods:</p>
<p><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;uptime&quot;, &quot;id&quot;:1 }' 127.0.0.1:5113</code></p>
<p>Server responds with:</p>
<p><code>{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;{\&quot;secs\&quot;:840968,\&quot;nanos\&quot;:0}&quot;,&quot;id&quot;:1}</code></p>
<h3><a class="header" href="#licensing-4" id="licensing-4">Licensing</a></h3>
<p>AGPL-3.0</p>
<h1><a class="header" href="#web-interface" id="web-interface">Web Interface</a></h1>
<p><a href="https://github.com/peachcloud/peach-web">peach-web</a> provides a web interface for monitoring and interacting with the PeachCloud device. This allows administration of the single-board computer (ie. Raspberry Pi) running PeachCloud, as well as the ssb-server and related plugins.</p>
<p><strong>Stack</strong></p>
<p>The peach-web stack currently consists of <a href="https://rocket.rs/">Rocket</a> (Rust web framework), <a href="https://tera.netlify.com/docs/installation/">Tera</a> (Rust template engine inspired by Jinja2 and the Django template language) and <a href="https://tachyons.io/">Tachyons</a> (functional CSS library for humans).</p>
<h1><a class="header" href="#configuration" id="configuration">Configuration</a></h1>
<p>The microservices and other components comprising the PeachCloud software are configurable via the following environment variables:</p>
<table><thead><tr><th>Microservice</th><th>Variable</th><th>Description</th><th>Default</th></tr></thead><tbody>
<tr><td>peach-network</td><td><code>PEACH_NETWORK_SERVER</code></td><td>HTTP server address and port for JSON-RPC</td><td><code>127.0.0.1:5110</code></td></tr>
<tr><td>peach-buttons</td><td><code>PEACH_BUTTONS_SERVER</code></td><td>WebSocket server address and port for JSON-RPC</td><td><code>127.0.0.1:5111</code></td></tr>
<tr><td>peach-oled</td><td><code>PEACH_OLED_SERVER</code></td><td>HTTP server address and port for JSON-RPC</td><td><code>127.0.0.1:5112</code></td></tr>
<tr><td>peach-stats</td><td><code>PEACH_STATS_SERVER</code></td><td>HTTP server address and port for JSON-RPC</td><td><code>127.0.0.1:5113</code></td></tr>
<tr><td>peach-web</td><td><code>ROCKET_ENV</code></td><td>Web application deployment mode</td><td><code>prod</code></td></tr>
<tr><td></td><td><code>ROCKET_TEMPLATE_DIR</code></td><td>Tera template directory</td><td><code>static/templates</code></td></tr>
<tr><td></td><td><code>PEACH_WEB_WS</code></td><td>WebSocket server port</td><td><code>5115</code></td></tr>
</tbody></table>
<h1><a class="header" href="#contributors-guide" id="contributors-guide">Contributor's Guide</a></h1>
<h1><a class="header" href="#licensing-5" id="licensing-5">Licensing</a></h1>
<p><a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL-3.0</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
